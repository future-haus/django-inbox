Inbox
=====

Inbox is a Django app to store messages for users. For each
message, various notifications can be sent out through other
channels like app push notifications, email.

Future channels: SMS, Web push

Quick start
-----------

1. Add "inbox" to your INSTALLED_APPS setting like this

    INSTALLED_APPS = [
        ...
        'inbox',
    ]

2. Include any desired pre-built views in your API, or build your own

3. Configure INBOX_CONFIG in your Django settings file, here's the default:


    INBOX_CONFIG = {
        # Message groups are used to organize the messages and provide preferences and their defaults
        'MESSAGE_GROUPS': [
            {
                'id': 'DEFAULT',
                'label': 'News and Updates',
                'description': 'General news and updates.',  # Can be used in clients to describe what this preference is for
                'is_preference': True,  # Whether this is just used for grouping purposes (False) or also as a preference (True)
                'use_preference': None,  # If is_preference is False, this defines which group to use as preference
                'preference_defaults': {  # True/False or if you don't want that preference set to None
                    'APP_PUSH': True,
                    'EMAIL': True,
                    'SMS': True,
                    'WEB_PUSH': True
                },
                'message_keys': []  # List of message keys that fall into this group
            }
        ],
    }

4. Run `python manage.py migrate` to create the polls models.

Concepts
========

#### Intro

This push notification medium includes a Firebase backend for sending and only supports the device grouping method to
send to which uses the `notification_key` generated by adding `registration_token`s to a device group for a given
`notification_key_name`. If there's every a desire to send to a specific `registration_token` 
(ie single physical device) we'll need to add in additional API endpoints and expand the send_messages method to handle
that. I don't forsee us needing to do this for any reason which is why it isn't included currently.

#### Message Groups

Message groups are used to define broader groups of specific messages that go out primarily to define user preferences
on whether they do or don't want to receive messages within that group. For example you may have a message group id
of 'FRIENDS' and that controls how and if a user would get notifications sent to them when a message within that group
is created. There should always be a `MESSAGE_GROUP` with an id of `default`, that is the one that will be used as the
fallback in certain cases where things aren't configured either intentionally or unintentionally.

#### Message Keys

These are the identifiers for the specific message content being sent out. For example, if
you needed to send an email/app push with the subject of "You have a new friend request!", that might have a key of
`new_friend_request`, this defines what templates django-inbox will look for to send out to the various mediums. If
a message key is not present in any `MESSAGE_GROUP` config an error will be raised.

#### Template Naming Convention

For the subject and body in the inbox:
* `inbox_{message_key}_subject.txt`
* `inbox_{message_key}_body.html`

For the subject:
* `inbox_{message_key}_subject_{'app_push'|'email'}.txt`

For the body:
* `inbox_{message_key}_body_{'app_push'}.txt`
* `inbox_{message_key}_body_{'email'}.html`

Templates also determine what mediums are sent to, if a template doesn't exist for a medium, that medium won't be used.
Each template receives the following data: user, link, data that were used when creating the `Message`

Test
====

Setup Postgres database to run tests.

    CREATE ROLE inbox WITH LOGIN PASSWORD 'password';
    ALTER USER inbox WITH superuser;
    CREATE DATABASE inbox;
    ALTER ROLE inbox SET client_encoding TO 'utf8';
    ALTER ROLE inbox SET default_transaction_isolation TO 'read committed';
    ALTER ROLE inbox SET timezone TO 'UTC';
    ALTER USER inbox CREATEDB;
    GRANT ALL PRIVILEGES ON DATABASE inbox TO inbox;

Build and Upload
================

Make sure you have twine in your system Python. Bump the version number in setup.py, major, minor, patch (semver). Commit
to repo and then run:

`python setup.py sdist bdist_wheel upload`

TODO
====

* [x] Move `message_preferences` action endpoint from the test suite Users view to a mixin that can be used by projects
  using this library easily.
* [ ] Remove inbox/permissions.py and setup/use django-common module.
* [ ] Remove JSON Schema field and setup/use django-common module.
* [ ] Add ability to update individual group message pref medium so that UIs that have auto-save can more easily use
   the APIs and not deal with race conditions due to network/server latency. Endpoint example: 
   `/api/v1/users/{userId}/message_preferences/{groupKey}/{medium}`
* [ ] Manage User subs to Topic (probably automatically based off Message Groups with an `is_topic` boolean, if they
  turn off push for that Message Group then they would unsubscribe that Topic)
* [ ] Define sensible defaults on each item in the config for message groups so that it can be shortened up in many 
  cases, also consider moving this portion to the database? Need to discover pros/cons of move to DB for these.
* [ ] Background sending as tasks in Google Cloud Tasks, this would probably just need to be custom backends for
  each one we want backgroundable, email, push, etc?
* [ ] Allow subject template to be consolidated by leaving off `_{medium}` on the filename and it will be used as the 
  fallback for any medium not specified. Body being separate will be required because it's also used to determine
  the medium(s) to send to, skipping any that are missing.
* [ ] Specify a message as a bundleable message, which will delay its send for a bit so that it can be bundled with
  similar messages if they come in within a specified time window. Requirements:
  * [ ] Specify a message as bundleable when it's created
  * [ ] Specify some sort of grouping identifier to know what other messages it can be bundled 
  with (eg `bundleable_group_id`) when the message is created.
  * [ ] Configure time windows for bundleable groups in Django settings, but still allow immediate sending if needed.
  * [ ] Configure template to use for each medium for a bundleable group.
* [x] Add a `message_id` if we need to handle message de-duplication.
* [ ] Handle case where a message key is duplicated
* [ ] Priority level for sending (cron would grab messages with higher priority first, probably some bottom limit still
  based on time created.)
* [ ] Handle sending to a Topic and not just a `User`
* [ ] Provide Django *TestCase mixin that will handle emptying app push outbox between each test run.
* [ ] Add ability to fail silently in production when performing Message create, possibly a shortcut wrapper that wraps
   it up so that direct model creation behaves like a normal django model
* [ ] Build support for message preferences for multi-tenant structures where you may have global preferences plus per
   tenant preferences. Initial thought for approaching this problem would be a settings value where you can define a
   method that receives the User and/or Message Preferences object and appends any multi-tenant specific preferences...
   when we do this we'll need to probably allow for groups of groups in the preferences structure, possibly by just
   using dot-notation on keh naming so that it's backwards compatible? Not sure yet on this.
* [ ] Build out support for SMS and Web Push, currently those can be configured even though they don't do anything.
